{% extends "survey/base.html" %}
{% load i18n %}

{%block add_js%}
<script src="{{ MEDIA_URL }}/sw/story.js" type="text/javascript"></script>
{% endblock %}
{% block col1 %}
<h1>{% trans "People" %}</h1>

{% include "base/messages.html" %}

{%if persons|length == 0 %}
<p class="alert alert-warning">
	{%trans "No user is registrer yet in your account, start by adding a user by clicking on the link 'Add a new person'"%}
</p>
{%else%}
<div id="page-help" style="display:none">{% trans "Below is the list of participants currently managed by you. Click the corresponding option next to the participant to complete the background or symptoms questionnaire for that person, or to remove a participant."%}</div>
<a class="button button-mini " rel="facebox" href="#page-help" data-facebox-height="450" data-facebox-width="550"><span class="icon icon-help-white">{% trans "Help about this page"%}</span></a>
{%endif%}
{%for p in persons%}{%if not p.last_intake%}<p class="alert alert-warning">{% blocktrans with name=p.name %}Please fill the background intake for the user {{name}} first{%endblocktrans%}</p>{%endif%}
{%endfor%}
<form action="" method="POST" id="users_form">{% csrf_token %}
<table border="0" id="people-table">
<tr>
	<th rowspan="2">{% trans "Name" %}</th>
	<th colspan="2">{% trans "Fill a questionnaire" %}</th>
</tr>
<tr>
	<th>{% trans "Background" %}<span class="tooltip icon icon-tip" title="{%trans "Background survey help"%}"></span></th>
	<th>{% trans "Symptoms" %}<span class="tooltip icon icon-tip" title="{%trans "Weekly survey help"%}"></span></th>	
</tr>	
{% for person in persons %}
<tr id="person-{{ person.pk }}" rel="{{person.global_id}}">
	<td class="person-name">
		<input type="checkbox" name="global_ids" value="{{ person.global_id}}"/> {{ person.name }} 
		<a rel="facebox" href="{{ person.get_edit_url }}" class="edit-user" data-facebox-height="360px" title="{%trans "Edit Person"%}"><img src="{{MEDIA_URL}}sw/edit.png" width="16" height="16" class="icon" title="{%trans "Edit Person"%}"/></a>
		<span id="cohort-{{person.pk}}"></span>
	</td>
    <td><a href="{{ person.get_profile_url }}" class="icon icon-survey survey-intake" id="person-{{person.pk}}-intake">{% trans "Background" %}</a>
	{% if person.last_intake %}
	<span class="last" title="{%trans "last survey date"%}">{{ person.last_intake|date:"d M Y H:i"}}</span>
	{%else%}
	<span class="last">{%trans "no previous survey"%}</span>
	{%endif%}
	</td>
    <td><a href="{{ person.get_survey_url }}" class="icon icon-survey survey-weekly" id="person-{{person.pk}}-weekly">{% trans "Symptoms" %}</a>
	{% if person.health_history|length > 0 %}
	{% with f=person.health_history|first %} 
	<span class="last" title="{%trans "last survey date"%}">{{ f.timestamp|date:"d M Y H:i"}}</span>
	{%endwith%}
	{%else%}
	<span class="last">{%trans "no previous survey"%}</span>
	{%endif%}
	</td>
</tr>
{% endfor %}
<tr>
	<td colspan="5" nowrap="nowrap" style="font-size:.9em">
	<input type="hidden" name="action" value="" id="input_action"/>
	{% trans "For the checked users" %} :
    <button type="button" onclick="submit_users('healthy')" class="button">{% trans "Mark as healthy" %}</button><span class="tooltip icon icon-tip" title="{%trans "mark as healthy help text"%}">&nbsp;</span>
	<button type="button" onclick="submit_users('delete')" class="button">{% trans "Delete member(s)" %}</button>
	</td>
</tr>
<tr>
	<td colspan="5" class="people-actions">
	<ul >
		<li><a href="{% url survey_people_add %}" class="action-add-people">{% trans "Add new person" %}</a></li>
		<li><a href="{% url cohort_form %}" class="action-cohort">{% trans "Register a participant in a Cohort" %}</a> <span class="tooltip icon icon-tip" title="{%trans "cohort subscription help text"%}"></li>
	</ul>
	</td>
</tr>
</table>
</form>
{% comment %}
<div id="history">
<dl>
	{% for person in persons %}
	<dt>{{person.name}}</dt>
	<dd>
	<ul>
	{% for health_line in person.health_history %}
      <li>{{ health_line.timestamp|date:"d/m" }}<img src="{{ MEDIA_URL }}/survey/img/diag-{{ health_line.status|default:'UNKNOWN' }}-{% if person.is_female %}female-{% endif %}small.png" title="{{ health_line.diag }}" alt="" /></li>
    {% endfor %}
	</ul>
	</dd>
    {% endfor %}
</dl>            
</div>	
{%endcomment%}
<h2>{%trans "Household diagnosis history" %}</h2>
<div id="story"></div>
<p class="alert alert-info">{% trans "The flu status of each participant is based on the symptoms you reported. <strong>This is not a medical diagnosis</strong>. We only ask for symptoms indicative of influenza-like illness, common colds, gastric flu. If you have other symptoms, or you are at all worried, we recommend that you contact your doctor or telephone NHS Direct / NHS 24."%}</p>
<script type="text/javascript">

StoryTable.media = '{{MEDIA_URL}}';

$(function() {

	
	var users = [ {% for p in persons %}'{{p.name}}'{%if not forloop.last%},{%endif%}{%endfor%} ];

var history = [	
 {% for h in history %}
 { date: new Date({{h.timestamp|date:"Y"}},{{h.timestamp|date:"m"}}-1,{{h.timestamp|date:"d"}}), diag:'{{ h.diag }}','status':'{{h.status}}', user: '{{h.survey_user.name }}' }{%if not forloop.last%},{%endif%}     
 {%endfor%}
];	
	var story = new StoryTable(history, users);
	story.render('story');
	
	$.getJSON('/cohort/subscriptions', function(data) {
		var subscribers = data.subscribers;
		var cohorts = data.cohorts;
		if(subscribers) {
			console.log(subscribers);
			for(var uid in subscribers) {
				var subs = subscribers[uid];
				title = '{%trans "Subscriptions for this user:"%}<br/>';
				for(var i=0; i < subs.length; ++i) {
					var c = subs[i];
					title += cohorts[c]+'<br/>';
				}
				$('#cohort-'+uid).attr('title',title).addClass("icon icon-cohort").tooltip();
			}
		}
	});
	
});

function edit_user() {
	var e = $(this);
	document.location = e.attr('rel');
}

function submit_users(action) {
	if(action == 'delete') {
		if( !confirm('{% trans "Delete selected users ?" %}') ) {
			return;
		}		
	}
	$('#input_action').val(action);
	$('#users_form').submit();
}

</script>
{% endblock %}


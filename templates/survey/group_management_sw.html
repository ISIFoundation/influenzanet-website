{% extends "survey/base.html" %}
{% load i18n survey %}

{% block col1 %}
<h1>{% trans "Manage household" %}</h1>

{% include "base/messages.html" %}

{%if persons|length == 0 %}
<p class="alert alert-warning">
	<span class="icon icon-warning">&nbsp;</span>{%trans "No user is registrer yet in your account, start by adding a user by clicking on the link 'Add a new person'"%}
</p>
{%else%}
<p>
<a href="/aide-premiers-pas/" title="{% trans "Help about this page"%}" class="button button-mini" id="button-help-page"><i class="icon icon-help-white"></i>{% trans "Help about this page"%}</a>
<span class="button" id="button-intro" style="display:none"><i class="icon icon-demo"></i>Démarrer la démonstration de cette page</span>
</p>
{%endif%}
{%if not wait_launch%} {# Do not check in wait launch context #}
	<p class="alert alert-warning" id="fill-intake-warning" style="display:none"><span class="icon icon-warning">&nbsp;</span>{%trans "Some users do not have a background questionnaire, please fill this survey for them"%}</p>
{%endif%}

{% if not has_vacc2017 %}
<p class="alert alert-info">
	Cette année nous proposons un <a href="{% url survey_run shortname="vacc2017" %}">questionnaire de début de saison sur la vaccination</a><br/>
	Ce questionnaire ne vous sera proposé que pour un seul participant de votre compte. (cliquez sur le lien ci-dessus pour le remplir)
</p>
{% endif %}

<form action="" method="POST" id="users_form">{% csrf_token %}
<table border="0" id="people-table">
<tr>
	<th rowspan="2">{% trans "Name" %}</th>
	<th colspan="2">{% trans "Fill a questionnaire" %}</th>
</tr>
<tr class="survey-types">
	<th>{% trans "Background" %} <span class="tooltip icon icon-tip" title="{%trans "Background survey help"%}"></span></th>
	<th>{% trans "Symptoms" %} <span class="tooltip icon icon-tip" title="{%trans "Weekly survey help"%}"></span></th>
	{% if 'pregnant' in cohorts %}
	<th>&nbsp;</th>
	{% endif %}
	{% if 'immuno' in cohorts %}
		<th>&nbsp;</th>
	{% endif %}
</tr>
{% for person in persons %}
<tr id="person-{{ person.pk }}" rel="{{person.global_id}}" class="person-row">
	<td class="person-name">
		<input type="checkbox" name="global_ids" value="{{ person.global_id}}"/>
		<div id="person-{{person.pk}}-identity" class="identity">
		{% if avatars %}
		{%if avatars %}<img id="person-{{person.pk}}-avatar"  src="{{avatars.url}}{{ person.avatar }}.png" class="avatar{% if not person.avatar %} tooltip" title="Vous pouvez définir une image associée à ce participant"{% endif %} width="32" height="32" />{%endif%}
		{% endif %}
		{{ person.name }}
		</div>
		<a id="person-{{person.pk}}-edit" rel="facebox" href="{{ person.get_edit_url }}" class="edit-user" data-facebox-width="720" data-facebox-height="{% if avatars %}600{% else %}350{% endif %}px" title="{%trans "Edit Person"%}"><span class="icon icon-edit tooltip" title="{%trans "Edit Person"%}"></span></a>
		<span id="cohort-{{person.pk}}"></span>
		{% if person.pregnant %}
			<span class="pregnant-cohort tooltip-pregnant" title="Ce participant pourra participer à l'étude G-GrippeNet. Pour cela il suffira de remplir le questionnaire 'fin de grossesse' une fois la grossesse de ce participant terminée."></span>
		{% endif %}
	</td>
    {%if wait_launch %}
	<td colspan="2">
		{% trans "The project is not started yet for this season" %}
	{%else%}
	<td {% if not person.last_intake %} class="survey-cell to-fill-first tooltip-alert" title="{% trans "Fill the intake survey for this participant to start his participation"%}"{%else%} class="survey-cell" {% endif %} id="person-{{person.pk}}-cell-intake">
		<a href="{{ person.get_profile_url }}" class="button fill-button survey-intake" id="person-{{person.pk}}-intake"><span class="icon icon-survey">&nbsp;</span>{% if person.last_intake %}Modifier{%else%}{% trans "Fill this survey" %}{% endif %}</a>
		{% if person.last_intake %}
		<span class="last" title="{%trans "last survey date"%} {{ person.last_intake|date:"d M Y H:i"}}">{% blocktrans with last=person.last_intake|survey_timesince %}last survey filled {{last}} ago{% endblocktrans %}</span>
		{%else%}
		<span class="last">{%trans "no previous survey"%}</span>
		{%endif%}
		</td>
	    <td id="person-{{person.pk}}-cell-weekly" class="survey-cell">
	    {% if person.last_intake %}
			<a href="{{ person.get_survey_url }}" class="button fill-button survey-weekly tooltip" id="person-{{person.pk}}-weekly" title="Remplissez le questionnaire hebdomadaire pour ce participant pour décrire ses symptomes actuels. "><span class="icon icon-survey">&nbsp;</span>{% trans "Fill this survey" %}</a>
			{% if person.last_weekly %}
			{% with f=person.last_weekly %}
			<span class="last" title="{%trans "last survey date"%} {{f|date:"d M Y H:i"}}">{% blocktrans with last=f|survey_timesince %}last survey filled {{last}} ago{% endblocktrans %}</span>
			{%endwith%}
			{%else%}
			<span class="last">{%trans "no previous survey"%}</span>
			{%endif%}
		{% else %}
			<span>{% trans "Fill profile first" %}</span>
		{% endif %}
	{%endif%}
	</td>
	{% if 'pregnant' in cohorts %}
	<td {% if person.pregnant %} class=" survey-cell pregnant" {% endif %}>
		{% if person.pregnant %}
		<a href="{% url survey_fill 'pregnant' %}?gid={{person.global_id}}" class="button fill-button survey-pregnant tooltip-pregnant" title="Cette saison le projet G-Grippnet étudie les épisodes de syndromes grippaux durant la grossesse. Pour compléter cette étude, nous demandons aux participantes enceinte de remplir ce questionnaire après la fin de leur grossesse.">Fin de grossesse</a>
		<span class="last">&nbsp;</span>
		{% endif %}
	</td>
	{% endif %}
	{% if 'immuno' in cohorts %}
	<td {% if person.immuno %} class=" survey-cell immuno" {% endif %}>
		{% if person.immuno %}
		<span class="tooltip" title="Ce participant est enregistré pour le projet ID-GrippeNet réalisant un suivi particulier des participants présentant une maladie inflammatoire ou auto-immune chronique recevant un traitement immunosuppresseur ou une biothérapie. Il pourra vous être proposé de remplir des questionnaires supplémentaires durant la saison">Projet ID-GrippeNet</span>
		{% endif %}
	</td>
	{% endif %}
</tr>
{% endfor %}
<tr>
	<td colspan="5" nowrap="nowrap" style="font-size:.9em">
	<input type="hidden" name="action" value="" id="input_action"/>
	{% trans "For the checked users" %} :
    {%if wait_launch %}
		&nbsp;
	{%else%}
	<button type="button" onclick="submit_users('healthy')" class="button" id="button-healthy">{% trans "Mark as healthy" %}</button><span class="tooltip icon icon-tip" title="{%trans "mark as healthy help text"%}">&nbsp;</span>
	{%endif%}
	<button type="button" onclick="submit_users('delete')" class="button" id="button-delete">{% trans "Delete member(s)" %}</button>
	</td>
</tr>
<tr>
	<td colspan="5" class="people-actions">
	<ul >
		<li><a href="{% url survey_people_add %}"  id="link-add-people" class="action-add-people" data-facebox-width="720" data-facebox-height="{% if avatars %}600{% else %}350{% endif %}px" title="{% trans "Add new person" %}" rel="facebox">{% trans "Add new person" %}</a></li>
		{% comment %}<li><a href="{% url cohort_form %}" class="action-cohort tooltip" title="{%trans "cohort subscription help text"%}"><span class="icon icon-cohort">&nbsp;</span>{% trans "Register a participant in a Cohort" %}</a> <span ></span></li>{% endcomment %}
	</ul>
	</td>
</tr>
</table>
</form>

{%if not wait_launch %}
		<p class="alert alert-info">
			<b>{%trans "How to update my vaccination status"%}</b><br/>
			{%trans "Update vaccination help"%}
		</p>
{%else%}

<div class="alert alert-warning">
	<p>{% trans "The project has not started yet for the season. We will contact you as soon as the follow-up begin." %}</p>
	<h4>{%trans "The project will be launched from the" %} <b>{{ wait_launch.date|date:"DATE_FORMAT"}}</b></h4>
</div>

{% endif %}
<script type="text/javascript">
var users = [ {% for p in persons %}'{{p.name}}'{%if not forloop.last%},{%endif%}{%endfor%} ];
var first_user = $('.person-row').first().attr('id');

$(function() {
	var fill_intake_warning = $('.to-fill-first');
	if(fill_intake_warning.length > 0) {
		$('#fill-intake-warning').show();
	}

	$('.tooltip-pregnant').tooltip({tipClass:'hovertip hovertip-pregnant'})

	if( !$.isOldIE() ) {
		$("#button-intro").show().click(loadIntro);
		$('#button-help-page').hide();
	}

{% comment %}
	$.getJSON('/cohort/subscriptions', function(data) {
		var subscribers = data.subscribers;
		var cohorts = data.cohorts;
		if(subscribers) {
			console.log(subscribers);
			for(var uid in subscribers) {
				var subs = subscribers[uid];
				title = '{%trans "Subscriptions for this user:"%}<br/>';
				for(var i=0; i < subs.length; ++i) {
					var c = subs[i];
					title += cohorts[c]+'<br/>';
				}
				$('#cohort-'+uid).attr('title',title).addClass("icon icon-cohort").tooltip();
			}
		}
	});
{% endcomment %}

});

function edit_user() {
	var e = $(this);
	document.location = e.attr('rel');
}

function submit_users(action) {
	if(action == 'delete') {
		if( !confirm('{% trans "Delete selected users ?" %}') ) {
			return;
		}
	}
	$('#input_action').val(action);
	$('#users_form').submit();
}

function loadIntro() {
	$.getScript('{{MEDIA_URL}}assets/survey.intro.js', function() {
		startIntro();
	});
}
</script>
{% endblock %}

